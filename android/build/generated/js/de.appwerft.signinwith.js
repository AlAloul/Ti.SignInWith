var providers={linkedin:{title:"LinkedIn",REQUEST_AUTHORIZATION_URL:"https://www.linkedin.com/oauth/v2/authorization",ACCESSTOKEN_URL:"https://www.linkedin.com/oauth/v2/accessToken",PROFILE_URL:"https://api.linkedin.com/v1/people/~:(id,first-name,last-name,num-connections,picture-url,maiden-name,headline,location,summary,email-address,positions)",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",
SCOPE:"r_basicprofile",version:2},slack:{title:"Slack",REQUEST_AUTHORIZATION_URL:"https://slack.com/oauth/authorize",ACCESSTOKEN_URL:"https://slack.com/api/oauth.access",PROFILE_URL:"https://slack.com/api/users.list",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"users:read",version:2},facebook:{title:"Facebook",REQUEST_AUTHORIZATION_URL:"https://www.facebook.com/dialog/oauth",
ACCESSTOKEN_URL:"https://graph.facebook.com/v2.3/oauth/access_token",PROFILE_URL:"https://graph.facebook.com/v2.3/me",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"public_profile",version:2},gplus:{title:"Google+",REQUEST_AUTHORIZATION_URL:"https://accounts.google.com/o/oauth2/auth",ACCESSTOKEN_URL:"https://www.googleapis.com/oauth2/v3/token",PROFILE_URL:"https://www.googleapis.com/plus/v1/people/me",
BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"https://www.googleapis.com/auth/tasks",version:2},dropbox:{title:"Dropbox",REQUEST_AUTHORIZATION_URL:"https://accounts.google.com/o/oauth2/auth",ACCESSTOKEN_URL:"https://www.googleapis.com/oauth2/v3/token",PROFILE_URL:"https://www.googleapis.com/plus/v1/people/me",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",
FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"https://www.googleapis.com/auth/tasks",version:2},github:{title:"Github",REQUEST_AUTHORIZATION_URL:"https://accounts.google.com/o/oauth2/auth",ACCESSTOKEN_URL:"https://www.googleapis.com/oauth2/v3/token",PROFILE_URL:"https://www.googleapis.com/plus/v1/people/me",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",
scope:"https://www.googleapis.com/auth/tasks",version:2}},_opt,_prop,_initialized=!1;function encodeQueryData(a){return Object.getOwnPropertyNames(a).map(function(d){return encodeURIComponent(d)+"="+encodeURIComponent(a[d])}).join("&")}
var init=function(a){_opt=providers[a];if(!_opt)return console.log("Error: "+a+" is not yet supported"),!1;_opt.propertyName=a+"Token";_opt.clientId=Ti.App.Properties.getString(a+"_id");_opt.clientSecret=Ti.App.Properties.getString(a+"_secret");_prop={accessToken:null,expiresIn:0};a={accessToken:Ti.App.Properties.getString(_opt.propertyName+".accessToken"),expiresIn:Ti.App.Properties.getString(_opt.propertyName+".expiresIn")};a.expiresIn>=(new Date).getTime()&&(_prop=a);_initialized=!0};
function _getToken(a,d){d=d?d:function(){};console.log("Try to get access token:");var e=Ti.Network.createHTTPClient({onload:function(){try{var a=JSON.parse(this.responseText);a.expires_in=parseFloat(a.expires_in,10)*1E3+(new Date).getTime();console.log(a.expires_in);Ti.App.Properties.setString(_opt.propertyName+".accessToken",a.access_token);Ti.App.Properties.setString(_opt.propertyName+".expiresIn",a.expires_in);_prop.accessToken=a.access_token;_prop.expiresIn=a.expires_in}catch(f){console.log("Error: by parsing JSON answer from server"),
console.log(f)}win.close();d()},onerror:function(){}}),g={grant_type:"authorization_code",code:a,redirect_uri:_opt.BLANK_DUMMY_WEBPAGE,client_id:_opt.clientId,client_secret:_opt.clientSecret};e.open("POST",_opt.ACCESSTOKEN_URL);e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");e.setRequestHeader("User-Agent",_opt.FAKE_USERAGENT);e.send(g)}
function _authorize(a){_initialized||init(_provider);win=Ti.UI.createWindow({backgroundImage:"/karo.png",modal:!0,theme:"Theme.AppCompat.NoTitleBar"});var d=Ti.UI.createActivityIndicator({zIndex:99,style:Ti.UI.ActivityIndicatorStyle.BIG_DARK});win.add(d);var e=[_opt.REQUEST_AUTHORIZATION_URL,encodeQueryData({approval_prompt:"force",redirect_uri:_opt.BLANK_DUMMY_WEBPAGE,response_type:"code",scope:[_opt.SCOPE],client_id:_opt.clientId,btmpl:"mobile"})].join("?");console.log(_opt);console.log("\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260Start Authorization against LinkedIn\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\n"+
e);var g=Ti.UI.createWebView({borderWidth:3,borderColor:"#1D87BD",borderRadius:5,enableZoomControls:!1,userAgent:_opt.FAKE_USERAGENT,transform:Ti.UI.create2DMatrix({scale:0.92})}),h=0,f=null;g.addEventListener("load",function(c){var b=null;h++;c=c.source.url;b=/code=(.*)/gm;if(b=b.exec(c))f=b[1],win.close(),f!=null&&(g.hide(),d.show(),_getToken(f,a));b=/error=(.*)/gm;if(b=b.exec(c))f=b[1],win.close(),f!=null&&console.log("Error: "+f)});g.setUrl(e);win.add(g);win.open()}
var getAccessToken=function(a){_initialized||init(a);return Ti.App.Properties.getString(_opt.propertyName+".accessToken",null)},getProfile=function(a,d){function e(){g++;var a=_opt.PROFILE_URL,c=Ti.App.Properties.getString(_opt.propertyName+".accessToken",null);if(c==null)_authorize(e);else{console.log("Info: doGet try this request: "+a);console.log("Info: doGet try this bearer: "+c);var b=Ti.Network.createHTTPClient({onload:function(){if(this.status==401)console.log("Warning: 401 => open login dialog"),
_authorize(e);else if(this.status==200)try{var a=JSON.parse(this.responseText);h({ok:!0,data:a})}catch(b){console.log(b),h({ok:!1,error:b})}},onerror:function(){try{var a=JSON.parse(this.responseText);console.log(a);_authorize(e)}catch(b){h({ok:!1,data:b})}}});b.open("GET",a);b.setRequestHeader("Content-Type","application/json");b.setRequestHeader("x-li-format","json");b.setRequestHeader("Connection","keep-alive");b.setRequestHeader("Authorization","Bearer "+c);b.send()}}_initialized||init(a);var g=
0,h=d;e()};
function createSelectDialog(a,d){var e=a||{},g=d||function(){},h=Object.getOwnPropertyNames(providers);if(Ti.Android){var f=Ti.UI.createView({layout:"vertical",opacity:0,backgroundColor:"white"});h.forEach(function(a){f.add(Ti.UI.createImageView({image:"https://raw.githubusercontent.com/AppWerft/Ti.SignInWith/master/documentation/"+a+".png?__",height:80,top:0,provider:a,borderWidth:5,borderColor:"white",width:"100%"}))});var c=Ti.UI.createAlertDialog({androidView:f,title:"Connect with your social provider:"});c.show();
f.animate({opacity:1});f.addEventListener("click",function(a){console.log(a.source.provider);g&&g(a.source.provider);c.hide();c=null})}else c=Ti.UI.createOptionDialog({cancel:h.length,title:e.title||"",options:h.push("Cancel")}),c.addEventListener("click",function(a){a.cancel!=a.index&&g&&(g(h[a.index]),c.hide(),c=null)}),c.show()}module.exports={getProfile:getProfile,getAccessToken:getAccessToken,createSelectDialog:createSelectDialog};
