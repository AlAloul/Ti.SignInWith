var providers={linkedin:{title:"LinkedIn",REQUEST_AUTHORIZATION_URL:"https://www.linkedin.com/oauth/v2/authorization",ACCESSTOKEN_URL:"https://www.linkedin.com/oauth/v2/accessToken",PROFILE_URL:"https://api.linkedin.com/v1/people/~:(id,first-name,last-name,num-connections,picture-url,maiden-name,headline,location,summary,email-address,positions)",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",
SCOPE:"r_basicprofile"},slack:{title:"Slack",REQUEST_AUTHORIZATION_URL:"https://www.linkedin.com/oauth/v2/authorization",ACCESSTOKEN_URL:"https://www.linkedin.com/oauth/v2/accessToken",PROFILE_URL:"https://api.linkedin.com/v1/",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"read"},facebook:{title:"Facebook",REQUEST_AUTHORIZATION_URL:"https://www.linkedin.com/oauth/v2/authorization",
ACCESSTOKEN_URL:"https://www.linkedin.com/oauth/v2/accessToken",PROFILE_URL:"https://api.linkedin.com/v1/",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"read"},gplus:{title:"Google+",REQUEST_AUTHORIZATION_URL:"https://www.linkedin.com/oauth/v2/authorization",ACCESSTOKEN_URL:"https://www.linkedin.com/oauth/v2/accessToken",PROFILE_URL:"https://api.linkedin.com/v1/",
BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"read"},twitter:{title:"Twitter",REQUEST_AUTHORIZATION_URL:"https://www.linkedin.com/oauth/v2/authorization",ACCESSTOKEN_URL:"https://www.linkedin.com/oauth/v2/accessToken",PROFILE_URL:"https://api.linkedin.com/v1/",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",
FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",scope:"read"}},_opt,_prop,_initialized=!1;function encodeQueryData(a){return Object.getOwnPropertyNames(a).map(function(b){return encodeURIComponent(b)+"="+encodeURIComponent(a[b])}).join("&")}
var init=function(a){_opt=providers[a];if(!_opt)return console.log("Error: "+a+" is not yet supported"),!1;_opt.propertyName=a+"Token";_opt.clientId=Ti.App.Properties.getString(a+"_id");_opt.clientSecret=Ti.App.Properties.getString(a+"_secret");_prop={accessToken:null,expiresIn:0};a={accessToken:Ti.App.Properties.getString(_opt.propertyName+".accessToken"),expiresIn:Ti.App.Properties.getString(_opt.propertyName+".expiresIn")};a.expiresIn>=(new Date).getTime()&&(_prop=a);_initialized=!0};
function _getToken(a,b){b=b?b:function(){};console.log("Try to get access token:");var c=Ti.Network.createHTTPClient({onload:function(){try{var a=JSON.parse(this.responseText);a.expires_in=parseFloat(a.expires_in,10)*1E3+(new Date).getTime();console.log(a.expires_in);Ti.App.Properties.setString(_opt.propertyName+".accessToken",a.access_token);Ti.App.Properties.setString(_opt.propertyName+".expiresIn",a.expires_in);_prop.accessToken=a.access_token;_prop.expiresIn=a.expires_in}catch(g){console.log("Error: by parsing JSON answer from server"),
console.log(g)}win.close();b()},onerror:function(){}}),e={grant_type:"authorization_code",code:a,redirect_uri:_opt.BLANK_DUMMY_WEBPAGE,client_id:_opt.clientId,client_secret:_opt.clientSecret};c.open("POST",_opt.ACCESSTOKEN_URL);c.setRequestHeader("Content-Type","application/x-www-form-urlencoded");c.setRequestHeader("User-Agent",_opt.FAKE_USERAGENT);c.send(e)}
function _authorize(a){_initialized||init(_provider);win=Ti.UI.createWindow({backgroundImage:"/karo.png",modal:!0,theme:"Theme.AppCompat.NoTitleBar"});var b=Ti.UI.createActivityIndicator({zIndex:99,style:Ti.UI.ActivityIndicatorStyle.BIG_DARK});win.add(b);var c=[_opt.REQUEST_AUTHORIZATION_URL,encodeQueryData({approval_prompt:"force",redirect_uri:_opt.BLANK_DUMMY_WEBPAGE,response_type:"code",scope:[_opt.SCOPE],client_id:_opt.clientId,btmpl:"mobile"})].join("?");console.log(_opt);console.log("\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260Start Authorization against LinkedIn\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\n"+
c);var e=Ti.UI.createWebView({borderWidth:3,borderColor:"#1D87BD",borderRadius:5,enableZoomControls:!1,userAgent:_opt.FAKE_USERAGENT,transform:Ti.UI.create2DMatrix({scale:0.92})}),f=0,g=null;e.addEventListener("load",function(c){var d=null;f++;c=c.source.url;d=/code=(.*)/gm;if(d=d.exec(c))g=d[1],win.close(),g!=null&&(e.hide(),b.show(),_getToken(g,a));d=/error=(.*)/gm;if(d=d.exec(c))g=d[1],win.close(),g!=null&&console.log("Error: "+g)});e.setUrl(c);win.add(e);win.open()}
var getAccessToken=function(a){_initialized||init(a);return Ti.App.Properties.getString(_opt.propertyName+".accessToken",null)},getProfile=function(a,b){function c(){e++;var a=_opt.PROFILE_URL,b=Ti.App.Properties.getString(_opt.propertyName+".accessToken",null);if(b==null)_authorize(c);else{console.log("Info: doGet try this request: "+a);console.log("Info: doGet try this bearer: "+b);var d=Ti.Network.createHTTPClient({onload:function(){if(this.status==401)console.log("Warning: 401 => open login dialog"),
_authorize(c);else if(this.status==200)try{var a=JSON.parse(this.responseText);f({ok:!0,data:a})}catch(b){console.log(b),f({ok:!1,error:b})}},onerror:function(){try{var a=JSON.parse(this.responseText);console.log(a);_authorize(c)}catch(b){f({ok:!1,data:b})}}});d.open("GET",a);d.setRequestHeader("Content-Type","application/json");d.setRequestHeader("x-li-format","json");d.setRequestHeader("Connection","keep-alive");d.setRequestHeader("Authorization","Bearer "+b);d.send()}}_initialized||init(a);var e=
0,f=b;c()};
function createSelectDialog(a,b){var c=b||function(){};if(Ti.Android){var e=Ti.UI.createView({layout:"vertical",opacity:0,backgroundColor:"white"});Object.getOwnPropertyNames(providers).forEach(function(a){e.add(Ti.UI.createImageView({image:"https://raw.githubusercontent.com/AppWerft/Ti.SignInWith/master/documentation/"+a+".png?__",height:80,top:0,provider:a,borderWidth:5,borderColor:"white",width:"100%"}))});var f=Ti.UI.createAlertDialog({androidView:e,title:"Connect with your social provider:"});f.show();
e.animate({opacity:1});e.addEventListener("click",function(a){console.log(a.source.provider);c&&c(a.source.provider);f.hide();f=null})}}module.exports={getProfile:getProfile,getAccessToken:getAccessToken,createSelectDialog:createSelectDialog};
