var providers={linkedin:{title:"LinkedIn",REQUEST_AUTHORIZATION_URL:"https://www.linkedin.com/oauth/v2/authorization",ACCESSTOKEN_URL:"https://www.linkedin.com/oauth/v2/accessToken",PROFILE_URL:"https://api.linkedin.com/v1/people/~:(id,first-name,last-name,num-connections,picture-url,maiden-name,headline,location,summary,email-address,positions)",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",
SCOPE:"r_basicprofile",version:2},slack:{title:"Slack",REQUEST_AUTHORIZATION_URL:"https://slack.com/oauth/authorize",ACCESSTOKEN_URL:"https://slack.com/api/oauth.access",PROFILE_URL:"https://slack.com/api/users.list",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",SCOPE:"users:read",version:2},facebook:{title:"Facebook",REQUEST_AUTHORIZATION_URL:"https://www.facebook.com/dialog/oauth",
ACCESSTOKEN_URL:"https://graph.facebook.com/v2.3/oauth/access_token",PROFILE_URL:"https://graph.facebook.com/v2.3/me",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",SCOPE:"public_profile",version:2},gplus:{title:"Google+",REQUEST_AUTHORIZATION_URL:"https://accounts.google.com/o/oauth2/auth",ACCESSTOKEN_URL:"https://www.googleapis.com/oauth2/v3/token",PROFILE_URL:"https://www.googleapis.com/plus/v1/people/me",
BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",SCOPE:"https://www.googleapis.com/auth/tasks",version:2},dropbox:{title:"Dropbox",REQUEST_AUTHORIZATION_URL:"https://www.dropbox.com/1/oauth2/authorize",ACCESSTOKEN_URL:"https://www.dropbox.com/1/oauth2/token",PROFILE_URL:"https://api.dropboxapi.com/2/users/get_current_account",BLANK_DUMMY_WEBPAGE:"https://upload.wikimedia.org/wikipedia/en/b/b1/Portrait_placeholder.png",
FAKE_USERAGENT:"Mozilla/5.0 (Macintosh; Intel Mac OS X x.y; rv:10.0) Gecko/20100101 Firefox/10.0",SCOPE:"",version:2}},_opt,_prop;function encodeQueryData(a){return Object.getOwnPropertyNames(a).map(function(c){return encodeURIComponent(c)+"="+encodeURIComponent(a[c])}).join("&")}
var init=function(a){_opt=providers[a];if(!_opt)return console.log("Error: "+a+" is not yet supported"),!1;_opt.propertyName=a+"Token";try{_opt.clientId=Ti.App.Properties.getString(a+"_clientId").replace(":",".")}catch(c){}_opt.clientSecret=Ti.App.Properties.getString(a+"_clientSecret");_opt.team=Ti.App.Properties.getString(a+"_team");_prop={accessToken:null,expiresIn:0};a={accessToken:Ti.App.Properties.getString(_opt.propertyName+".accessToken"),expiresIn:Ti.App.Properties.getString(_opt.propertyName+
".expiresIn")};a.expiresIn>=(new Date).getTime()&&(_prop=a);console.log(_opt)};function _cacheLogo(a,c){var b=Ti.Filesystem.getFile(Ti.Filesystem.applicationCacheDirectory,c);if(b.exists())a.setImage(b.nativePath);else{var e=Ti.Network.createHTTPClient({onload:function(){b.write(this.responseData);a.setImage(b.nativePath)}});e.open("GET","https://raw.githubusercontent.com/AppWerft/Ti.SignInWith/master/documentation/"+c+".png");e.send()}}
function _getToken(a,c){c=c?c:function(){};console.log("Try to get access token:");var b=Ti.Network.createHTTPClient({onload:function(){try{var a=JSON.parse(this.responseText);a.expires_in=parseFloat(a.expires_in,10)*1E3+(new Date).getTime();console.log(a.expires_in);Ti.App.Properties.setString(_opt.propertyName+".accessToken",a.access_token);Ti.App.Properties.setString(_opt.propertyName+".expiresIn",a.expires_in);_prop.accessToken=a.access_token;_prop.expiresIn=a.expires_in}catch(b){console.log("Error: by parsing JSON answer from server"),
console.log(b)}win.close();c()},onerror:function(){}}),e={grant_type:"authorization_code",code:a,redirect_uri:_opt.BLANK_DUMMY_WEBPAGE,client_id:_opt.clientId,client_secret:_opt.clientSecret};b.open("POST",_opt.ACCESSTOKEN_URL);b.setRequestHeader("Content-Type","application/x-www-form-urlencoded");b.setRequestHeader("User-Agent",_opt.FAKE_USERAGENT);b.send(e)}
function _authorize(a){win=Ti.UI.createWindow({backgroundImage:"/karo.png",modal:!0,theme:"Theme.AppCompat.NoTitleBar"});var c=Ti.UI.createActivityIndicator({zIndex:99,style:Ti.UI.ActivityIndicatorStyle.BIG_DARK});win.add(c);var b=[_opt.REQUEST_AUTHORIZATION_URL,encodeQueryData({approval_prompt:"force",redirect_uri:_opt.BLANK_DUMMY_WEBPAGE,response_type:"code",scope:[_opt.SCOPE],team:_opt.team,client_id:_opt.clientId,btmpl:"mobile"})].join("?");console.log(_opt);console.log("\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260Start Authorization against\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\u2260\n"+
b);var e=Ti.UI.createWebView({borderWidth:3,borderColor:"#1D87BD",borderRadius:5,enableZoomControls:!1,userAgent:_opt.FAKE_USERAGENT,transform:Ti.UI.create2DMatrix({scale:0.92})}),g=0,f=null;e.addEventListener("load",function(b){var d=null;g++;b=b.source.url;d=/code=(.*)/gm;if(d=d.exec(b))f=d[1],win.close(),f!=null&&(e.hide(),c.show(),_getToken(f,a));d=/error=(.*)/gm;if(d=d.exec(b))f=d[1],win.close(),f!=null&&console.log("Error: "+f)});e.setUrl(b);win.add(e);win.open()}
var getAccessToken=function(){return Ti.App.Properties.getString(_opt.propertyName+".accessToken",null)},getProfile=function(a,c){function b(){e++;var a=_opt.PROFILE_URL,c=Ti.App.Properties.getString(_opt.propertyName+".accessToken",null);if(c==null)_authorize(b);else{console.log("Info: doGet try this request: "+a);console.log("Info: doGet try this bearer: "+c);var d=Ti.Network.createHTTPClient({onload:function(){if(this.status==401)console.log("Warning: 401 => open login dialog"),_authorize(b);else if(this.status==
200)try{var a=JSON.parse(this.responseText);g({ok:!0,data:a})}catch(d){console.log(d),g({ok:!1,error:d})}},onerror:function(){try{var a=JSON.parse(this.responseText);console.log(a);_authorize(b)}catch(d){g({ok:!1,data:d})}}});d.open("GET",a);d.setRequestHeader("Content-Type","application/json");d.setRequestHeader("x-li-format","json");d.setRequestHeader("Connection","keep-alive");d.setRequestHeader("Authorization","Bearer "+c);d.send()}}console.log(a+"\n...................");init(a);var e=0,g=c;b()};
function createSelectDialog(a,c){var b=a||{},e=c||function(){},g=Object.getOwnPropertyNames(providers);if(Ti.Android){var f=Ti.UI.createView({layout:"vertical",opacity:0,top:10,backgroundColor:"white"});g.forEach(function(a){var b=Ti.UI.createImageView({image:"https://raw.githubusercontent.com/AppWerft/Ti.SignInWith/master/documentation/"+a+".png",height:80,top:0,provider:a,borderWidth:5,borderColor:"white",width:"90%"});_cacheLogo(b,a);f.add(b)});var h=Ti.UI.createAlertDialog({androidView:f,title:"Connect with your social provider:"});
h.show();f.animate({opacity:1});f.addEventListener("click",function(a){console.log(a.source.provider);e&&e(a.source.provider);h.hide();h=null})}else h=Ti.UI.createOptionDialog({cancel:g.length,title:b.title||"",options:g.push("Cancel")}),h.addEventListener("click",function(a){a.cancel!=a.index&&e&&(e(g[a.index]),h.hide(),h=null)}),h.show()}module.exports={getProfile:getProfile,getAccessToken:getAccessToken,createSelectDialog:createSelectDialog};
